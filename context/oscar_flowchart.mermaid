flowchart TD
    %% Input Layer
    A[ğŸ¤ User Input] --> B{Input Type?}
    B -->|Voice| C[ğŸ”Š Speech-to-Text<br/>Vosk/Whisper]
    B -->|Text| D[ğŸ“ Text Input]
    C --> E[ğŸ“‹ Natural Language Processing]
    D --> E
    
    %% Context Gathering
    E --> F[ğŸ§  Context Gathering Agent]
    F --> G[ğŸ“Š Session History<br/>Retrieval]
    F --> H[ğŸ” Vector Store Search<br/>RAG Memory]
    F --> I[âš™ï¸ System State<br/>Detection]
    
    %% Context Integration
    G --> J[ğŸ”— Context Integration<br/>& Enrichment]
    H --> J
    I --> J
    
    %% Multi-Agent Planning System
    J --> K[ğŸ¤– Master Planning Agent]
    K --> L{Task Complexity?}
    
    %% Simple vs Complex Task Routing
    L -->|Simple| M[âš¡ Direct Execution<br/>Planning Agent]
    L -->|Complex| N[ğŸ§© Multi-Agent<br/>Orchestrator]
    
    %% Multi-Agent System for Complex Tasks
    N --> O[ğŸ¯ Task Decomposition<br/>Agent]
    O --> P[ğŸ“‹ Sub-task Creation]
    
    P --> Q{Sub-task Type?}
    Q -->|System Command| R[ğŸ’» System Command<br/>Specialist Agent]
    Q -->|Web Automation| S[ğŸŒ Web Automation<br/>Specialist Agent]
    Q -->|File Operations| T[ğŸ“ File Management<br/>Specialist Agent]
    Q -->|Information Gathering| U[ğŸ” Research<br/>Specialist Agent]
    
    %% Agent Collaboration
    R --> V[ğŸ¤ Agent Collaboration<br/>& Dependency Resolution]
    S --> V
    T --> V
    U --> V
    
    %% Plan Generation
    M --> W[ğŸ“„ Execution Plan<br/>Generation]
    V --> W
    
    %% Safety Analysis
    W --> X[ğŸ›¡ï¸ Safety Analysis Agent]
    X --> Y[âš ï¸ Risk Assessment<br/>Pattern Matching]
    X --> Z[ğŸ”’ Security Validation<br/>Path & Command Check]
    
    Y --> AA[ğŸ“Š Risk Level<br/>Determination]
    Z --> AA
    
    %% Dynamic Confirmation System
    AA --> BB{Risk Level?}
    BB -->|Low/Medium| CC[âœ… Simple Confirmation<br/>Agent]
    BB -->|High| DD[âš¡ Enhanced Confirmation<br/>Agent]
    BB -->|Dangerous| EE[ğŸš¨ Maximum Security<br/>Confirmation Agent]
    
    %% User Confirmation Process
    CC --> FF[ğŸ‘¤ User Decision]
    DD --> GG[ğŸ“‹ Step-by-Step Review<br/>+ Final Confirmation]
    EE --> HH[ğŸ” Type CONFIRM<br/>+ Password + Final Check]
    
    GG --> FF
    HH --> FF
    
    %% Execution or Rejection
    FF --> II{Approved?}
    II -->|No| JJ[âŒ Plan Rejected<br/>Logged & Terminated]
    II -->|Yes| KK[âš™ï¸ Execution Orchestrator]
    
    %% Execution System
    KK --> LL[ğŸ”„ Tool Selection<br/>& Routing Agent]
    LL --> MM{Tool Type?}
    
    MM -->|Shell| NN[ğŸ’» Shell Execution<br/>Agent]
    MM -->|Browser| OO[ğŸŒ Browser Automation<br/>Agent]
    MM -->|File Ops| PP[ğŸ“ File Operations<br/>Agent]
    MM -->|Custom| QQ[ğŸ”§ Plugin Tool<br/>Agent]
    
    %% Tool Execution
    NN --> RR[ğŸ“Š Result Collection<br/>& Validation]
    OO --> RR
    PP --> RR
    QQ --> RR
    
    %% Result Processing
    RR --> SS[ğŸ“‹ Result Aggregation<br/>Agent]
    SS --> TT[âœ… Success/Failure<br/>Analysis]
    
    %% Memory Updates
    TT --> UU[ğŸ§  Memory Update Agent]
    UU --> VV[ğŸ’¾ Session History<br/>Update]
    UU --> WW[ğŸ” Vector Store<br/>Update - RAG]
    UU --> XX[ğŸ“Š Context Learning<br/>& Pattern Storage]
    
    %% Audit & Logging
    VV --> YY[ğŸ“ Audit Logger<br/>Agent]
    WW --> YY
    XX --> YY
    JJ --> YY
    
    YY --> ZZ[ğŸ“‹ Complete Action<br/>Audit Trail]
    
    %% Output Generation
    TT --> AAA[ğŸ“¤ Response Generation<br/>Agent]
    AAA --> BBB{Output Mode?}
    BBB -->|Text| CCC[ğŸ“ Text Response]
    BBB -->|Voice| DDD[ğŸ”Š Text-to-Speech<br/>Response]
    
    CCC --> EEE[âœ¨ User Feedback<br/>& Session Update]
    DDD --> EEE
    
    %% Continuous Learning Loop
    EEE --> FFF[ğŸ”„ Feedback Analysis<br/>Agent]
    FFF --> GGG[ğŸ“ˆ Model Improvement<br/>& Adaptation]
    GGG --> H
    
    %% Styling
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef agentStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef safetyStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef executionStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef memoryStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef decisionStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class A,B,C,D,E inputStyle
    class F,K,N,O,R,S,T,U,V,LL,SS,UU,YY,AAA,FFF agentStyle
    class X,Y,Z,AA,CC,DD,EE safetyStyle
    class KK,NN,OO,PP,QQ,RR,TT executionStyle
    class G,H,I,J,VV,WW,XX,GGG memoryStyle
    class L,Q,BB,II,MM,BBB decisionStyle